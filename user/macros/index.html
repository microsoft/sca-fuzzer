
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A security-oriented tool for testing CPUs and detecting microarchitectural leaks like Spectre and Meltdown">
      
      
        <meta name="author" content="Microsoft">
      
      
        <link rel="canonical" href="https://github.com/microsoft/sca-fuzzer/user/macros/">
      
      
        <link rel="prev" href="../templates/">
      
      
        <link rel="next" href="../../devel/overview/">
      
      
      <link rel="icon" href="../../assets/ms_icon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.30">
    
    
      
        <title>Macros - Revizor</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#macros" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Revizor" class="md-header__button md-logo" aria-label="Revizor" data-md-component="logo">
      
  <img src="../../assets/ms_icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Revizor
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Macros
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/sca-fuzzer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/sca-fuzzer
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../contracts/" class="md-tabs__link">
        
  
    
  
  Theoretical Foundations

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../cli/" class="md-tabs__link">
          
  
  User Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../devel/overview/" class="md-tabs__link">
          
  
  Developer Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/fuzzing-campaign/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Revizor" class="md-nav__button md-logo" aria-label="Revizor" data-md-component="logo">
      
  <img src="../../assets/ms_icon.png" alt="logo">

    </a>
    Revizor
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/sca-fuzzer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/sca-fuzzer
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contracts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Theoretical Foundations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    User Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            User Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command Line Interface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modes of Operation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration Options
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../minimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Minimization Passes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../actors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Actors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../templates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Templates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Macros
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Macros
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-a-macro" class="md-nav__link">
    <span class="md-ellipsis">
      What is a macro?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#macro-definition-and-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Macro Definition and Usage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Macro Definition and Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#assembly-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      Assembly Syntax
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Example Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#available-macro-types" class="md-nav__link">
    <span class="md-ellipsis">
      Available Macro Types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#internal-representation-of-macros" class="md-nav__link">
    <span class="md-ellipsis">
      Internal Representation of Macros
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macros-in-executor" class="md-nav__link">
    <span class="md-ellipsis">
      Macros in Executor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macros-in-model" class="md-nav__link">
    <span class="md-ellipsis">
      Macros in Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Developer Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Guidelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Advanced Topics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Advanced Topics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/registers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Register Allocation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/sandbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test Case Sandbox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/macros/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Macros
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/dr-model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DynamoRIO backend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/binary-formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Formats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devel/code-generation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test Case Code Generation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/fuzzing-campaign/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Designing a Revizor Fuzzing Campaign
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/root-causing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Root-Causing a Violation Detected by Revizor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/tsa-sq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Detecting TSA-SQ with Revizor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-a-macro" class="md-nav__link">
    <span class="md-ellipsis">
      What is a macro?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#macro-definition-and-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Macro Definition and Usage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Macro Definition and Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#assembly-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      Assembly Syntax
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Example Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#available-macro-types" class="md-nav__link">
    <span class="md-ellipsis">
      Available Macro Types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#internal-representation-of-macros" class="md-nav__link">
    <span class="md-ellipsis">
      Internal Representation of Macros
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macros-in-executor" class="md-nav__link">
    <span class="md-ellipsis">
      Macros in Executor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macros-in-model" class="md-nav__link">
    <span class="md-ellipsis">
      Macros in Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="macros">Macros</h1>
<p>This document explains the concept of macros in Revizor and describes how to create test cases that use macros.</p>
<p>Note that macros are especially useful in the template-based mode of Revizor, so if you are not familiar, check out the <a href="../templates/">Template-Based Mode</a> documentation as well.</p>
<h2 id="what-is-a-macro">What is a macro?</h2>
<p>Macros in Revizor are special pseudo-instructions that provide a flexible way to insert complex operations into test cases. They appear as labels of a special format in the assembly code but are dynamically expanded into actual implementations during execution by the model and the executor.</p>
<p>Macros solve two key challenges, especially in the context of multi-domain testing:</p>
<ul>
<li>Structuring: Enable insertion of pre-defined instruction sequences (like domain transitions or microarchitectural isolation primitives) within randomized test contexts</li>
<li>Unification: Allow the same test case template to be instantiated differently across executor and model stages, accommodating differences in ISA support.</li>
</ul>
<h2 id="macro-definition-and-usage">Macro Definition and Usage</h2>
<h3 id="assembly-syntax">Assembly Syntax</h3>
<p>Macros use standard assembly syntax of a label with the <code>.macro</code> prefix:</p>
<div class="highlight"><pre><span></span><code>.macro.macro_name.argument1.argument2.argument3.argument4:
</code></pre></div>
<p>A macro can take at most four arguments. The arguments are strictly static; Revizor does not support dynamic arguments in macros, such as registers or memory addresses.</p>
<h3 id="example-usage">Example Usage</h3>
<p>A user can create a test case program where only a subset of instruction is measured by using <code>measurement_start</code> and <code>measurement_end</code> macros:</p>
<div class="highlight"><pre><span></span><code><span class="na">.intel_syntax</span><span class="w"> </span><span class="no">noprefix</span>
<span class="na">.section</span><span class="w"> </span><span class="no">.data.main</span>

<span class="na">...</span><span class="w"> </span><span class="c1">; non-measured code here</span>

<span class="nl">.macro.measurement_start:</span>

<span class="na">...</span><span class="w"> </span><span class="c1">; measured code here</span>

<span class="nl">.macro.measurement_end:</span>

<span class="na">...</span><span class="w"> </span><span class="c1">; non-measured code here</span>

<span class="nl">.test_case_exit:</span>
</code></pre></div>
<p>Revizor will automatically replace the macros with no-op operations of an ISA-dependent size, and record the location and the arguments of the macros in the test case metadata. When the executor and the model run the test case, they will recognize these macros and execute the corresponding logic. Note that the logic can be configurable, e.g., when the user has set <code>executor_mode: P+P</code> (prime+probe), the <code>measurement_start</code> macro will correspond the Prime stage of the measurement, and <code>measurement_end</code> will correspond to the Probe stage.</p>
<p>See <a href="#implementation-overview">Implementation Overview</a> for details on how macros are implemented in the executor and model.</p>
<h2 id="available-macro-types">Available Macro Types</h2>
<p><strong>Measurement Macros:</strong></p>
<ul>
<li><code>measurement_start</code>: Begin hardware/contract trace collection</li>
<li><code>measurement_end</code>: End hardware/contract trace collection</li>
</ul>
<p><strong>Fault Handling Macros:</strong></p>
<ul>
<li><code>fault_handler</code>: Label the location where control flow should be redirected upon an exception or interrupt</li>
</ul>
<p>Example usage:
<div class="highlight"><pre><span></span><code>mov rdx, 0
mov rax, 0
mov rbx, 0
div rbx  ; This will cause a division by zero exception

.fault_handler:
    ; Execute some code after the fault
    mov rax, 1
</code></pre></div></p>
<p>Note that if <code>fault_handler</code> is not defined, the executor will use a default handler that jumps to the exit point of the test case.</p>
<p><strong>Generation Macros:</strong></p>
<ul>
<li><code>random_instructions.N</code>: Generate N random instructions. This macro is intended to be used in the template-based mode.</li>
</ul>
<p>Example usage:
<div class="highlight"><pre><span></span><code>mov rax, 0
mov rbx, 0
.random_instructions.10:  ; Generate 10 random instructions
mul rax, rcx
</code></pre></div></p>
<p><strong>Actor Transition Macros:</strong></p>
<ul>
<li>Host-guest transitions:<ul>
<li><code>set_h2g_target</code>: Set VM entry point</li>
<li><code>set_g2h_target</code>: Set VM exit point</li>
<li><code>switch_h2g</code>: Host to guest transition</li>
<li><code>landing_h2g</code>: Label guest landing point</li>
<li><code>switch_g2h</code>: Guest to host transition</li>
<li><code>landing_g2h</code>: Label host landing point</li>
</ul>
</li>
<li>Kernel-user transitions:<ul>
<li><code>set_k2u_target</code>: Set user mode entry point</li>
<li><code>set_u2k_target</code>: Set kernel mode entry point</li>
<li><code>switch_k2u</code>: Kernel to user transition</li>
<li><code>switch_u2k</code>: User to kernel transition</li>
<li><code>landing_k2u</code>: Kernel to user landing point</li>
<li><code>landing_u2k</code>: User to kernel landing point</li>
</ul>
</li>
</ul>
<p>See <a href="../actors/">Actors</a> for more details and examples of how to use these macros.</p>
<h2 id="implementation-overview">Implementation Overview</h2>
<h3 id="internal-representation-of-macros">Internal Representation of Macros</h3>
<p>Revizor internally replaces all macros with a no-op placeholder of a fixed size (8 bytes for x86-64, 12 bytes for ARM64). This placeholder is used to maintain the original instruction flow while allowing the executor and model to recognize and handle macros dynamically. The macro location, type, and arguments are stored in the test case metadata, namely in the <code>SYMBOL TABLE</code> section of the <a href="../../devel/binary-formats/">RCBF File Format</a>, where <code>owner</code> is set to the actor ID of the actor that contains the macro, <code>offset</code> is the offset of the macro placeholder in the code section of the actor, <code>id</code> is the macro type (defined in <a href="https://github.com/microsoft/sca-fuzzer/blob/main/src/x86/executor/include/macro_loader.h">executor_km/include/macro_expansion.h</a>), and <code>args</code> is a compressed representation of the macro arguments.</p>
<h3 id="macros-in-executor">Macros in Executor</h3>
<p>Each actor's code section contains a dedicated memory region for macros, and the implementation is copied there during test case initialization. The executor copies the implementations of all macros into this section, and it replaces the macro placeholders with direct jumps to the corresponding implementations. The executor also inserts a return jump at the end of each macro implementation to return control flow back to the original instruction sequence.</p>
<p>For example, if we have a simple test case like this:</p>
<div class="highlight"><pre><span></span><code><span class="nl">.macro.measurement_start:</span>
<span class="na">...</span><span class="w"> </span><span class="c1">; some code here</span>
<span class="nl">.macro.measurement_end:</span>
<span class="nl">.test_case_exit:</span>
</code></pre></div>
<p>The executor with expand it as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nf">jump</span><span class="w"> </span><span class="no">measurement_start_impl</span>
<span class="nf">lfence</span>
<span class="nl">.l1:</span>
<span class="na">...</span><span class="w"> </span><span class="c1">; some code here</span>
<span class="nf">jump</span><span class="w"> </span><span class="no">measurement_end_impl</span>
<span class="nf">lfence</span>
<span class="nl">.l2:</span>
<span class="nl">.test_case_exit:</span>

<span class="nl">.macro_code_section:</span>
<span class="nl">measurement_start_impl:</span>
<span class="na">...</span><span class="w"> </span><span class="c1">; sequence of instructions that implements the macro</span>
<span class="nf">jump</span><span class="w"> </span><span class="no">.l1</span><span class="w">  </span><span class="c1">; jump to the end of the macro section</span>

<span class="nl">measurement_end_impl:</span>
<span class="na">...</span><span class="w"> </span><span class="c1">; sequence of instructions that implements the macro</span>
<span class="nf">jump</span><span class="w"> </span><span class="no">.l2</span><span class="w">  </span><span class="c1">; jump to the end of the macro section</span>
</code></pre></div>
<p>Note that the executor also inserts LFENCE barriers after each macro jump. This is to ensure that the macro execution does not trigger straight-line speculation, which could interfere with the measurement process.</p>
<h3 id="macros-in-model">Macros in Model</h3>
<p>In the model, macros are implemented as dynamic callbacks. The model executes a hook function on every instruction execution, checking if the current instruction matches an entry in the symbol table. If a match is found, the model invokes the corresponding callback function to emulate the macro behavior.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Microsoft
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs", "search.share"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A security-oriented tool for testing CPUs and detecting microarchitectural leaks like Spectre and Meltdown">
      
      
        <meta name="author" content="Microsoft">
      
      
        <link rel="canonical" href="https://github.com/microsoft/sca-fuzzer/contracts/">
      
      
        <link rel="prev" href="../quick-start/">
      
      
        <link rel="next" href="../user/cli/">
      
      
      <link rel="icon" href="../assets/ms_icon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.30">
    
    
      
        <title>Theoretical Foundations - Revizor</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#primer-speculation-contracts-and-model-based-relational-testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Revizor" class="md-header__button md-logo" aria-label="Revizor" data-md-component="logo">
      
  <img src="../assets/ms_icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Revizor
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Theoretical Foundations
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/sca-fuzzer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/sca-fuzzer
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../quick-start/" class="md-tabs__link">
        
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
    
  
  Theoretical Foundations

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../user/cli/" class="md-tabs__link">
          
  
  User Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../devel/overview/" class="md-tabs__link">
          
  
  Developer Documentation

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Revizor" class="md-nav__button md-logo" aria-label="Revizor" data-md-component="logo">
      
  <img src="../assets/ms_icon.png" alt="logo">

    </a>
    Revizor
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/sca-fuzzer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/sca-fuzzer
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Theoretical Foundations
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Theoretical Foundations
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#information-flow-properties" class="md-nav__link">
    <span class="md-ellipsis">
      Information-Flow Properties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#noninterference-definition-and-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Noninterference: Definition and Examples
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beyond-direct-outputs-side-channels" class="md-nav__link">
    <span class="md-ellipsis">
      Beyond Direct Outputs: Side Channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#challenges-of-side-channel-noninterference" class="md-nav__link">
    <span class="md-ellipsis">
      Challenges of Side-Channel Noninterference
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#speculation-contracts-dealing-with-the-complexity-of-modern-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Speculation Contracts: Dealing with the Complexity of Modern Hardware
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-and-testing-speculation-contracts" class="md-nav__link">
    <span class="md-ellipsis">
      Building and Testing Speculation Contracts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-based-relational-testing-and-revizor" class="md-nav__link">
    <span class="md-ellipsis">
      Model-Based Relational Testing and Revizor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sources-and-further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Sources and Further Reading
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            User Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command Line Interface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modes of Operation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration Options
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/minimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Minimization Passes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/fuzzing-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Violation Root-Causing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Developer Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Guidelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Advanced Topics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Advanced Topics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/registers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Register Allocation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/sandbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test Case Sandbox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/macros/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Macros
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/dr-model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DynamoRIO backend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/binary-formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Formats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devel/code-generation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test Case Code Generation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#information-flow-properties" class="md-nav__link">
    <span class="md-ellipsis">
      Information-Flow Properties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#noninterference-definition-and-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Noninterference: Definition and Examples
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beyond-direct-outputs-side-channels" class="md-nav__link">
    <span class="md-ellipsis">
      Beyond Direct Outputs: Side Channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#challenges-of-side-channel-noninterference" class="md-nav__link">
    <span class="md-ellipsis">
      Challenges of Side-Channel Noninterference
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#speculation-contracts-dealing-with-the-complexity-of-modern-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Speculation Contracts: Dealing with the Complexity of Modern Hardware
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-and-testing-speculation-contracts" class="md-nav__link">
    <span class="md-ellipsis">
      Building and Testing Speculation Contracts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-based-relational-testing-and-revizor" class="md-nav__link">
    <span class="md-ellipsis">
      Model-Based Relational Testing and Revizor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sources-and-further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Sources and Further Reading
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="primer-speculation-contracts-and-model-based-relational-testing">Primer: Speculation Contracts and Model-Based Relational Testing</h1>
<blockquote>
<p>Author: Oleksii Oleksenko | Last Updated: 2025-04-02</p>
</blockquote>
<p>Below is a brief primer on the theoretical foundations of speculation contracts and model-based relational testing—concepts that underlie the Revizor tool. This primer provides a high-level overview of the topic, introducing the concepts of noninterference, speculation contracts, and model compliance.</p>
<p>This document is intended for those new to the topic, particularly people without a background in information-flow analysis. For a more detailed and technical explanation, refer to the <a href="https://arxiv.org/pdf/2006.03841">original contracts paper</a>.</p>
<h2 id="information-flow-properties">Information-Flow Properties</h2>
<p>We will start with the basics: the concepts of confidentiality and noninterference, which are fundamental to understanding how speculation contracts work.</p>
<p>Traditionally, security mechanisms like access control and encryption have focused on protecting data at rest or in transit. However, these mechanisms do not address the problem of <strong>information flow</strong> within a system.
For example, consider a program that reads a secret input and then writes it to a public output, such as a web server that logs failed login attempts along with the username and masked password entered. Even if the program is secure in the sense that it does not allow unauthorized access to the secret data, it may still leak the secret through its public output, such as logging "User admin failed login with password starting with 'P@ss'" — revealing partial information about the secret password. This is where <strong>information-flow security</strong> comes into play.</p>
<p>Information-flow security is concerned with how data moves through a computation and how it can be observed by an attacker. The goal is to ensure that secret information does not leak to observers who are unauthorized to access it. An <strong>end-to-end confidentiality policy</strong> might be stated as: <em>“No secret input data can be inferred by an attacker through observations of system output.”</em> In other words, even if an adversary can see all public outputs of a computation, they should learn nothing about the secret inputs.</p>
<p><strong>Information-flow properties</strong> generally classify program variables or inputs/outputs into security levels (e.g., <code>Secret</code> and <code>Public</code>). The key property for confidentiality is that <em>no information flows from Secret to Public.</em> But how can information flow? There are two primary routes:</p>
<ul>
<li>
<p><strong>Explicit flows:</strong> These occur when confidential data is directly assigned or passed into a public variable or output. For example, in code, writing <code>public = secret</code> is an explicit flow from a secret variable to a public variable (an obvious violation of confidentiality). Any mechanism that directly transfers the bits of a secret into a publicly observable sink is an explicit flow. Such flows are usually straightforward to detect.</p>
</li>
<li>
<p><strong>Implicit flows:</strong> These occur indirectly, through the control structure of the program. An implicit flow arises when the <em>control path</em> taken by a program (e.g., which branch of an <code>if</code> or how many loop iterations) depends on a secret, thereby implicitly leaking information.</p>
</li>
</ul>
<blockquote>
<p><strong>Example 1 (Implicit Flow)</strong></p>
<p>Consider this pseudocode example:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Sec</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Here <code>Sec</code> is a secret input and <code>Pub</code> is a public output. There is no direct assignment of <code>Sec</code> to <code>Pub</code>. However, an observer of <code>Pub</code> can deduce information about <code>Sec</code>. In fact, this program sets <code>Pub</code> to 0 if <code>Sec</code> was 0; otherwise, it sets <code>Pub</code> to 1—effectively copying the one-bit information “is Sec zero?” into <code>Pub</code>. This is an implicit flow of information from <code>Sec</code> to <code>Pub</code> through the control structure (the <code>if</code> condition on <code>Sec</code>).</p>
</blockquote>
<h2 id="noninterference-definition-and-examples">Noninterference: Definition and Examples</h2>
<p><strong>Noninterference</strong> is a formal property that captures the idea of perfect confidentiality: changes in secret data have <em>no observable effect</em> on public outputs. This property can be formalized as: <em>"a system is noninterferent if variations in Secret inputs cause no differences in Public outputs"</em>. Equivalently, confidential inputs do not interfere with the publicly visible state of the system.</p>
<p>To make this more concrete, imagine we run a program twice with two different secret inputs but the same public inputs. If <strong>no attacker can distinguish</strong> the two runs by observing anything public, then the program satisfies the noninterference property. The “attacker” here is assumed to have complete access to all public outputs, which are formalized as a function <code>PublicOut</code>:</p>
<div class="highlight"><pre><span></span><code>output = PublicOut(Sec, Pub)
</code></pre></div>
<p>Noninterference essentially demands that for any two secrets <code>Sec1</code> and <code>Sec2</code> and any public input <code>Pub</code>, the program’s behavior from an attacker’s perspective is identical when run on <code>(Sec1, Pub)</code> versus <code>(Sec2, Pub)</code>:</p>
<p><center>
&nbsp;&nbsp;&nbsp;<strong>Definition 1 (Noninterference)</strong>: A program <code>P</code> is noninterferent if, for all public inputs <code>Pub</code> and all secret inputs <code>Sec1</code>, <code>Sec2</code>, if <code>Sec1 = Sec2</code>, then <code>PublicOut(P, Sec1, Pub) = PublicOut(P, Sec2, Pub)</code>.
</center></p>
<p>Here are some examples to illustrate this principle:</p>
<blockquote>
<p><strong>Example 2 (Interfering program)</strong></p>
<p>Suppose our program simply copies a secret to output:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sec</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Running it with two different secrets clearly yields different public outputs (e.g., <code>output</code> becomes 5 in one run and 7 in another). An attacker would distinguish these runs, so the program is <strong>not</strong> noninterferent—it blatantly leaks information.</p>
</blockquote>
<hr />
<blockquote>
<p><strong>Example 3 (Noninterfering program)</strong></p>
<p>A trivial example of a noninterferent program is one that produces no output dependent on the secret. For instance:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">assign_zero</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>This program ignores secret <code>sec</code> entirely and always sets the public output <code>output</code> to 0. No matter what the secret input is, the public output is constant (0), so an attacker gains no information about <code>sec</code>. Indeed, any two runs are indistinguishable (both runs output 0). This satisfies noninterference (albeit by doing nothing useful with the secret).</p>
</blockquote>
<hr />
<blockquote>
<p><strong>Example 4 (Allowed benign dependency)</strong></p>
<p>It is possible for a program to use secret data internally yet still be noninterferent as long as the final public outputs don’t reveal those secrets. For instance:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">mask_secret</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sec</span><span class="p">;</span>
<span class="w">    </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// multiply secret by 0</span>
<span class="w">    </span><span class="o">*</span><span class="n">output</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Here the program <em>did</em> read the secret (<code>sec</code>) and even manipulated it, but it “washed out” the secret by multiplying by 0. The value assigned to <code>output</code> is always 0. From an external view, this is just like the previous example—no dependence of <code>output</code> on <code>sec</code>. Noninterference is concerned only with <em>what can be observed by the attacker</em>, not with whether the program internally used the secret. As long as any use of the secret eventually has no effect on outputs, the policy holds.</p>
<p>Naturally, this example is not useful either, as it does nothing with the secret. In practice, however, there are techniques to ensure noninterference while still making use of secret data for useful computations. We won't go into these techniques here as they are beyond the scope of this primer.</p>
</blockquote>
<hr />
<p>One important insight is that noninterference is relative to a given specification of what is “observable.” If you consider only the functional outputs as observable, a program might be noninterferent in that model. But if in reality the attacker can observe more (e.g., the execution time of a program), then the program that was secure in theory might be insecure in practice. This leads us to examine how <em>side channels</em> break the assumptions of basic noninterference.</p>
<h2 id="beyond-direct-outputs-side-channels">Beyond Direct Outputs: Side Channels</h2>
<p>The original works on information-flow properties focused on direct outputs of a program (e.g., writing to a file or a network socket). However, in practice, attackers can extract information from more than just the “official” outputs of a program. For example, the attacker might observe how long a computation takes or measure the power consumption of a device. These additional sources of information are called <strong>side channels</strong>. Side channels are unintended channels through which secret data can be inferred by observing the system’s behavior, even if the direct outputs are secure.</p>
<p>These side channels can reveal information about the secret inputs, and so we must include them in the definition of noninterference. Similarly to how we defined <code>PublicOut(Sec, Pub)</code> as the observable output, we can define <code>Trace</code> as the observable side-channel information for a given program <code>P</code>.</p>
<div class="highlight"><pre><span></span><code>trace = Trace(P, Sec, Pub)
</code></pre></div>
<p>For example, a trace might be the execution time of the program or its cache access pattern.</p>
<p>Noninterference then requires that the traces of two runs with different secrets - <code>(Sec1, Pub)</code> versus <code>(Sec2, Pub)</code> - are indistinguishable to an attacker. This is a stronger requirement than just looking at the functional outputs.</p>
<p><center>
&nbsp;&nbsp;&nbsp;<strong>Definition 2 (Side-Channel Noninterference)</strong>: Given a side channel that produces a trace <code>Trace</code>, a program <code>P</code> is noninterferent with respect to this side channel if, for all public inputs&nbsp;<code>Pub</code> and all secret inputs <code>Sec1</code>, <code>Sec2</code>, if <code>Sec1 = Sec2</code>,<br>then <code>Trace(P, Sec1, Pub) = Trace(P, Sec2, Pub)</code>.
</center></p>
<p>Here are some examples of side channels and how they can violate noninterference:</p>
<blockquote>
<p><strong>Example 5 (Timing side channel)</strong></p>
<p>Consider a program that reads a compares a password with a user’s input:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">check_password</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">attempt</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pswd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">pswd</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attempt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pswd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// mismatch found, return early</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// all characters matched</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>If the attacker can measure how long the function takes to reject a guess, they can infer the password one character at a time. This leakage surfaces as a violation of the noninterference property with respect to timing observations.</p>
<p>A counterexample to Definition 2 could be as follows: Let's say we have two inputs with the same secret value but different public values:</p>
<ul>
<li><code>input1={attempt="abc", pswd="aaa"}</code></li>
<li><code>input2={attempt="aab", pswd="aaa"}</code></li>
</ul>
<p>The traces of these inputs will be:</p>
<ul>
<li><code>trace1 = Trace(check_password, input1) = 1</code></li>
<li><code>trace2 = Trace(check_password, input2) = 2</code></li>
</ul>
<p>These inputs constitute a violation of Definition 2, as <code>trace1 != trace2</code> even though the two inputs have the same secret value.</p>
</blockquote>
<hr />
<blockquote>
<p><strong>Example 6 (Cache side channel)</strong></p>
<p>Consider a program that uses a secret value to index into an array, as in the following code:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pub</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">sec</span><span class="p">];</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pub</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>A co-located attacker could observe the cache access pattern of the program by using Prime+Probe or Flush+Reload attack. Such traces can reveal the addresses accessed by the program and thus leak the secret value. This leakage would violate the noninterference property with respect to cache observations.</p>
<p>A violation could be surfaced by two inputs:</p>
<ul>
<li><code>input1={array=0x10000, pub=1, sec=0x40}</code></li>
<li><code>input2={array=0x10000, pub=1, sec=0x80}</code></li>
</ul>
<p>Let's assume that the cache line size is 64 bytes, and the cache is direct-mapped, meaning that the cache line ID is based on the memory access address <code>addr</code> as <code>line_id = (addr % 0x1000) // 0x40</code>. Since the array access in the first line of <code>multiply</code> will access two different addresses for the two inputs, they will also produce two different traces:</p>
<ul>
<li><code>trace1 = Trace(multiply, input1) = ((0x10000 + 0x40) % 0x1000) // 0x40 = 1</code></li>
<li><code>trace2 = Trace(multiply, input2) = ((0x10000 + 0x80) % 0x1000) // 0x40 = 2</code></li>
</ul>
<p>Since we have two inputs that match on the secret value <code>sec</code> but differ on the cache trace, this constitutes a violation of Definition 2.</p>
</blockquote>
<h2 id="challenges-of-side-channel-noninterference">Challenges of Side-Channel Noninterference</h2>
<p>Despite its completeness, the above formalization of side-channel noninterference is too simplistic to faithfully capture the side effects of program execution on modern, highly optimized hardware, especially CPUs. There are two key challenges:</p>
<ul>
<li>
<p><em>Challenge 1 - Noisy and Non-Deterministic Traces</em>: The traces observed by the attacker over a side channel are typically noisy, non-deterministic, and depend on the microarchitectural state of the CPU. For example, cache access patterns can be influenced by other programs running on the machine, the operating system and its interrupts, and can depend on microarchitectural buffers like store buffers or branch history tables. This means that the <code>Trace</code> function is not a simple deterministic function of the program inputs, but a complex function of many factors, some of which affect the result concurrently and in a non-deterministic fashion.</p>
</li>
<li>
<p><em>Challenge 2 - Unknown Side Channels</em>: Modern CPUs have a plethora of side channels, including cache timing, branch prediction, and many others. To ensure complete confidentiality, we need to check that the program does not leak information over <em>any</em> of them. This is a challenging task, as we do not know the full set of possible side channels when it comes to commercial hardware with proprietary microarchitectures. For example, a CPU might have an obscure microarchitectural optimization that vastly expands possibilities for information leaks, as was the case with Spectre and Meltdown vulnerabilities. Not including this optimization will undermine the noninterference analysis. Therefore, to test for noninterference comprehensively, we need a way to discover and reason about all possible side channels that could leak information.</p>
</li>
</ul>
<p>The next two sections discuss how speculation contracts address these challenges.</p>
<h2 id="speculation-contracts-dealing-with-the-complexity-of-modern-hardware">Speculation Contracts: Dealing with the Complexity of Modern Hardware</h2>
<p>As a solution to the first challenge, Guarnieri et al. (2021) introduced the concept of <strong>speculation contracts</strong>. A speculation contract is a simplified and deterministic model of the hardware, designed to capture the information that a given program <em>could</em> leak over side channels when executed with the given inputs. The key term here is "could"—the contract is not meant to exactly predict the side-channel traces, but instead, it errs on the side of caution, overestimating the possible leaks to achieve deterministic and noise-free traces.</p>
<p>A speculation contract works by defining two key aspects for every instruction in the CPU's ISA:</p>
<ol>
<li>
<p><strong>Observation Clause</strong>: For each instruction that may have an observable side effect, the contract declares an observation clause. It describes the data exposed by the instruction.</p>
</li>
<li>
<p><strong>Execution Clause</strong>: For each instruction whose semantics may be affected by hardware optimizations (e.g., speculative execution), the contract declares an execution clause. It describes the effect of such optimizations, but without specifying the exact mechanism of the optimization.</p>
</li>
</ol>
<p>At a high level, a contract implements a function <code>ContractTrace</code> that maps a program <code>P</code> and its inputs <code>Sec, Pub</code> to a contract trace <code>ctrace</code>. It is essentially a conservative approximation of the <code>Trace</code> function.</p>
<div class="highlight"><pre><span></span><code>ctrace = ContractTrace(P, Sec, Pub)
</code></pre></div>
<p>The contract trace is a sequence of all data that is exposed when a program is executed according to a contract. It captures the side-channel observations that <em>could be visible</em> if the CPU followed the speculation contract’s rules for a given program execution.</p>
<p>Accordingly, the noninterference property is redefined in terms of the contract trace:</p>
<p><center>
&nbsp;&nbsp;&nbsp;<strong>Definition 3 (Contract Noninterference)</strong>: Given a contract that produces a contract trace&nbsp;<code>ContractTrace</code>, a program <code>P</code> is noninterferent with respect to this contract if,<br>for all public inputs&nbsp;<code>Pub</code> and all secret inputs <code>Sec1</code>, <code>Sec2</code>, if <code>Sec1 = Sec2</code>,<br>then <code>ContractTrace(P, Sec1, Pub) = ContractTrace(P, Sec2, Pub)</code>.
</center></p>
<p>The following examples illustrate how a contract can be used to model side-channel leaks on a CPU.</p>
<blockquote>
<p><strong>Example 7: Memory Observation Contract, MEM-SEQ</strong></p>
<p>Let's imagine a CPU with a shared data cache and no other optimizations (i.e., no speculation). A co-located attacker can recover the addresses of loads/stores by observing which of the cache sets changed their state via a cache timing side-channel attack (e.g., Prime+Probe). We can encode these expectations in an observation clause for loads and stores by specifying that they expose their address. Since the CPU does not speculate, the execution clause for all instructions is empty. We call this contract MEM-SEQ (memory leakage with sequential execution), and it can be summarized as a table:</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>Observation Clause</th>
<th>Execution Clause</th>
</tr>
</thead>
<tbody>
<tr>
<td>Load</td>
<td>Expose Address</td>
<td>-</td>
</tr>
<tr>
<td>Store</td>
<td>Expose Address</td>
<td>-</td>
</tr>
<tr>
<td>Other</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note that MEM-SEQ intentionally overestimates the leaks by assuming that the attacker observes complete addresses loads/stores (in contrast to a subset of bits that are actually leaked in practice) and that <em>all</em> loads/stores are observable (in reality, they might be masked by noise or other factors). This overestimation is intentional to ensure that the contract is conservative and captures all possible corner cases.</p>
<p>Let's now consider how we can produce a contract trace using MEM-SEQ. We will use a slightly modified version of the <code>multiply</code> function from Example 6:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pub</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">sec</span><span class="p">];</span><span class="w">   </span><span class="c1">// MEM-SEQ exposes: &amp;array[sec]</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">pub</span><span class="p">];</span><span class="w">   </span><span class="c1">// MEM-SEQ exposes: &amp;array[pub]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>The inputs are:</p>
<ul>
<li><code>input1 = {array=0x10000, pub=1, sec=2}</code></li>
<li><code>input2 = {array=0x10000, pub=1, sec=3}</code></li>
</ul>
<p>The model collects a trace by executing the program line-by-line according to the rules in the table above (in practice, this is usually done using a modified CPU emulator). The first line has a load from memory, so the model records the address <code>&amp;array[sec]</code> as exposed. The second line has another load, so the model records the address <code>&amp;array[pub]</code> as exposed. The contract traces for this program would be:</p>
<ul>
<li><code>ctrace1 = ContractTrace(multiply, input1) = [0x10002, 0x10001]</code></li>
<li><code>ctrace2 = ContractTrace(multiply, input2) = [0x10003, 0x10001]</code></li>
</ul>
<p>Finally, this model can be used to check for noninterference by comparing contract traces according to Definition 3. In this case, we have two inputs with matching public values and different secrets, and they produced different contract traces, <code>ctrace1 != ctrace2</code>. This constitutes a violation and means that the <code>multiply</code> function is not noninterferent with respect to MEM-SEQ.</p>
</blockquote>
<hr />
<blockquote>
<p><strong>Example 8: Branch Prediction Contract, MEM-COND</strong></p>
<p>Now let's consider a more complex scenario, with a CPU that implements branch prediction—a common form of speculative execution. In this case, the CPU may incorrectly predict branch targets and execute instructions that are not part of the correct control flow. We can model this behavior in a contract by introducing an execution clause for conditional jumps that specifies the mispredicted target. To make the example useful, we will assume that the CPU also has a data cache, so the observation clause for loads and stores remains the same as in MEM-SEQ. We call this contract MEM-COND (memory leakage with conditional branch misprediction).</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>Observation Clause</th>
<th>Execution Clause</th>
</tr>
</thead>
<tbody>
<tr>
<td>Load</td>
<td>Expose Address</td>
<td>-</td>
</tr>
<tr>
<td>Store</td>
<td>Expose Address</td>
<td>-</td>
</tr>
<tr>
<td>Cond. Jump</td>
<td>-</td>
<td>Mispredict Target</td>
</tr>
<tr>
<td>Other</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>As a target program we will use the following function:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">conditional_multiply</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pub</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">pub</span><span class="p">];</span><span class="w">   </span><span class="c1">// MEM-COND exposes: &amp;array[pub]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">         </span><span class="c1">// MEM-COND mispredicts (assume z = 10)</span>
<span class="w">        </span><span class="n">z</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">sec</span><span class="p">];</span><span class="w">  </span><span class="c1">// MEM-COND exposes: &amp;array[sec]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>and a pair of inputs with the same public value but different secrets:</p>
<ul>
<li><code>input1 = {array=0x10000, pub=1, secret=2}</code></li>
<li><code>input2 = {array=0x10000, pub=1, secret=3}</code></li>
</ul>
<p>The first line of <code>conditional_multiply</code> has a load, so it exposes its address, <code>&amp;array[pub]</code>. For the sake of this example, let's assume this load returns <code>10</code>, so the next branch is not supposed to be taken. However, according to MEM-COND, branches take the wrong target, so the model executes the third line anyway. This line is a load, so it exposes the address <code>&amp;array[sec]</code>. After this, the program terminates, and the resulting traces are:</p>
<ul>
<li><code>ctrace1 = ContractTrace(conditional_multiply, input1) = [0x10002, 0x10001]</code></li>
<li><code>ctrace2 = ContractTrace(conditional_multiply, input2) = [0x10003, 0x10001]</code></li>
</ul>
<p>Again, the traces are different, so the program violates noninterference with respect to MEM-COND.
Notably, however, these two inputs would <em>not</em> violate noninterference with respect to MEM-SEQ, as the branch at line 2 would not be mispredicted, and the traces would be identical:</p>
<p><code>ctrace_mem_seq1 = ctrace_mem_seq2 = [0x10001]</code></p>
</blockquote>
<h2 id="building-and-testing-speculation-contracts">Building and Testing Speculation Contracts</h2>
<p>Speculation contracts are typically built by hand, with the initial versions based on public knowledge of the CPU's microarchitecture and its side-channel vulnerabilities. However, in the case of commercial CPUs, the exact details of the microarchitecture are often proprietary and not publicly disclosed. In these cases, the contract could—and often will—be incomplete. This is where the testing of speculation contracts becomes crucial: the initial "draft" of a contract is tested against the real hardware to ensure that it captures all side-channel leaks that the CPU exhibits. If the contract misses something, it is refined based on the results of the testing, and the process is repeated until the contract is deemed safe to use.</p>
<p>But how do we test a speculation contract? A naive approach might be to directly compare the traces produced by the model with the traces collected from the real CPU for the same program and inputs. However, this approach is generally not feasible because the contract traces intentionally overestimate the hardware traces, so mismatches are expected. Moreover, the model might expose information differently than the real hardware (e.g., the model might expose load/store addresses, while the hardware exposes cache set indexes), meaning direct comparison is often impossible.</p>
<p>Instead, a more precise approach is to compare <em>the information contained in the traces</em>. The idea is to check that the information exposed by the model is a strict superset of the information exposed by the real hardware. This is done by verifying that all inputs producing identical contract traces for a given program also produce identical hardware traces. If this property holds for all possible programs and inputs (ignore the complexity question for now), then any program that would be noninterferent with respect to the real hardware is guaranteed to be noninterferent with respect to the speculation contract. At this point, the model is safe to use as a proxy for real hardware when analyzing side-channel leaks.</p>
<p>To formalize this idea, let's introduce a new function <code>HardwareTrace</code> to denote the trace collected from the real hardware, and it will take an extra argument <code>Ctx</code> to capture the fact that real-world hardware traces depend on the microarchitectural state (e.g., on the state of branch predictors or caches).</p>
<p><center>
&nbsp;&nbsp;&nbsp;<strong>Definition 4: Contract Compliance</strong>.
A CPU complies with a speculation contract if, for all programs <code>P</code>, all input pairs <code>(Sec1, Pub), (Sec2, Pub)</code>, and all initial microarchitectural states&nbsp;<code>Ctx</code>, if <code>ContractTrace(P, Sec1, Pub) = ContractTrace(P, Sec2, Pub)</code>, then <code>HardwareTrace(P, Sec1, Pub, Ctx) = HardwareTrace(P, Sec2, Pub, Ctx)</code>.
</center></p>
<p>and conversely</p>
<p><center>
&nbsp;&nbsp;&nbsp;<strong>Definition 5: Contract Violation</strong>.
A CPU violates a speculation contract if there exists a program&nbsp;<code>P</code>, a microarchitectural state&nbsp;<code>Ctx</code>, and two inputs <code>(Sec1, Pub), (Sec2, Pub)</code> such that <code>ContractTrace(P, Sec1, Pub) = ContractTrace(P, Sec2, Pub)</code> and <br><code>HardwareTrace(P, Sec1, Pub, Ctx) != HardwareTrace(P, Sec2, Pub, Ctx)</code>.
</center></p>
<p>We call the tuple <code>(P, Ctx, Sec1, Sec2)</code> a <strong>contract counterexample</strong>. The counterexample demonstrates that an adversary can learn more information from hardware traces than what the contract specifies. A counterexample indicates a potential microarchitectural leakage that was not accounted for by the contract. The goal of Revizor is to find such counterexamples.</p>
<h2 id="model-based-relational-testing-and-revizor">Model-Based Relational Testing and Revizor</h2>
<p>Revizor applies the principles above, and provides a framework for building executable speculation contracts together with a mechanism to test real hardware (currently only CPUs) against these contracts by searching for contract counterexamples, as in Definition 5. However, there are certain issues that appear when the theory from the previous section is applied in practice, which we had to address in Revizor.</p>
<p>The first issue is the search space: testing all possible programs and inputs is literally impossible. We mitigate this issue by relying on a sampling-based approach, similar to fuzzing, where we approximate the complete search space via random sampling. Specifically, Revizor generates small (50-100 instructions long) programs, creates random inputs for them, collects both the contract and hardware traces for these inputs, and checks whether any of the traces constitute a contract counterexample. This process is called <em>Model-based Relational Testing</em>, and it is detailed further in the <a href="../devel/overview/">Architecture Overview</a>.</p>
<p>This approach works well in practice because any given hardware optimization can typically be triggered by many different programs, and we need to find only one instance to detect a violation. Evidence of this is the <a href="https://microsoft.github.io/sca-fuzzer/">list of trophies</a> that Revizor has already amassed.</p>
<p>The second issue we encountered is nondeterminism. As mentioned earlier, hardware traces can be non-deterministic due to various factors like interrupts or other programs running on the machine. To handle this, we use statistical methods: Revizor collects hardware traces for each program-input pair multiple times and then compares their distributions. If the distributions of the traces are statistically similar, Revizor considers the traces to be equivalent. This approach helps us account for noise in the hardware traces while still making reliable decisions about contract compliance.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this primer, we have introduced the concepts of noninterference, side channels, and speculation contracts, which all underlie the design of Revizor:</p>
<ul>
<li>The hardware fuzzer in Revizor uses speculation contracts and the concepts of noninterference (1) to detect unexpected side channels and dangerous microarchitectural optimizations in commercial CPUs, and (2) to aid in building sound leakage models for those CPUs.</li>
<li>The software fuzzer in Revizor (<em>NOTE: currently under construction</em>) uses the leakage models produced by the hardware fuzzer, and applies the principles of noninterference testing to detect side-channel vulnerabilities in real-world software.</li>
</ul>
<p>With these two components, we aim to provide a comprehensive tool for discovering and mitigating side-channel vulnerabilities software that can handle even the most obscure and complex microarchitectural optimizations in modern hardware.</p>
<hr />
<h2 id="sources-and-further-reading">Sources and Further Reading</h2>
<ul>
<li>A. Sabelfeld and A. C. Myers. <em>Language-Based Information-Flow Security</em>. IEEE Journal on Selected Areas in Communications, 21(1), 2003. (Survey of information-flow security, implicit/explicit flows, covert channels, etc.)</li>
<li>J. A. Goguen and J. Meseguer. <em>Security Policies and Security Models</em>. IEEE Symposium on Security and Privacy, 1982. (Origin of noninterference as a security policy formalism.)</li>
<li>J. B. Almeida et al. <em>Verifying Constant-Time Implementations</em>. USENIX Security Symposium, 2016. (Constant-time programming principles and the ct-verif tool for automated verification.)</li>
<li>M. Guarnieri, B. Köpf, J. Reineke, P. Vila. <em>Hardware-Software Contracts for Secure Speculation</em>. IEEE Symposium on Security and Privacy, 2021. (Original paper on speculation contracts.)</li>
<li>O. Oleksenko, C. Fetzer, B. Köpf, M. Silberstein. <em>Revizor: Testing Black-box CPUs against Speculation Contracts</em>. ACM International Conference on Architectural Support for Programming Languages and Operating Systems (ASPLOS), 2022. (Paper describing Model-based Relational Testing and Revizor.)</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Microsoft
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tabs", "search.share"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>